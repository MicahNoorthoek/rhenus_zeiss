<style>
.accordion {
  padding-top: 50px;
}


.accordionDiv {
  display: flex;
  justify-content: center;
}

  .balancesHistoryDiv {
    display: flex;
    justify-content: center;
  }

  label {
    font-weight: 600;
  }
</style>

<div class="warehousebalancesuniqueidentifier content-squish-screens" style="background-color: #f4f4f4; padding: 20px; border-left: 3px solid #000000;">
  <h1>Record Balances</h1>

  <%= form_for report_balances_path, remote: true do |f| %>

  <div class="row justify-content-center" style="text-align: center; margin-bottom:40px;">
    <div class="col-4">
      <div class="form-group">
        <%= label_tag :warehouse, "Warehouse" %>
        <%= text_field_tag :warehouse, Selectedwarehouse.pluck(:warehouse), class: 'form-control', style: "text-align: center;", readonly: true %>
        <%= f.hidden_field :recalculated_with_btn, value: @recalculated_with_btn, id: 'recalculated_with_btn' %>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-3">
      <div class="form-group">
        <%= f.label :balancedate, "Balance Date *" %>
        <%= f.datetime_local_field :balancedate, value: @balance_params.try(:dig, "balancedate"), class: 'form-control', id: "balancedate" %><br>
        <p id='select-balancedate-error' style='float:left; display:none; font-size: 13px; margin-top: -20px !important;'>*Required</p>
      </div>
    </div>

    <div class="col-3">
      <div class="form-group" style="padding-bottom: 20px;">
        <%= label_tag :itemnumber, "Product *" %>
        <%= select_tag :itemnumber, options_for_select([@balance_params.try(:dig, "itemnumber") || 'Select a Product'] + @part_numbers.collect {|p| [p.partnumber]}),{ autofocus: true, class: " form-control mb-3", id: "part-select-dropdown-balances", id: "itemnumber", required: true}%>
        <p id='select-itemnumber-error' style='float:left; display:none; font-size: 13px; margin-top: -15px !important;'>*Required</p>
      </div>
    </div>

    <div class="col-3">
      <div class="form-group">
        <%= f.label :uom, "UOM" %>
        <%= f.text_field :uom, value: @balance_params.try(:dig, "uom"), class: 'form-control', readonly: true, id: 'uom-text-field-balances' %>
      </div>
    </div>

    <div class="col-3">
      <div class="form-group" style="padding-bottom: 20px;">
        <%= f.label :balancequantity, "Balance Quantity *" %>
        <%= f.text_field :balancequantity, value: @balance_params.try(:dig, "balancequantity"), class: 'form-control', id: "balancequantity" %><br>
        <p id='select-balancequantity-error' style='float:left; display:none; font-size: 13px; margin-top: -20px !important;'>*Required</p>
      </div>
    </div>
  </div>


  <!-- Add a div for the submit button -->
  <div class="row">
    <div class="col-md-12 text-center">
      <div class='position-centerish' style='height:50px;'>
        <%= f.submit 'Record Balance', class: 'btn btn-sm btn-primary', style: "width:50%;" %>
      </div>
    </div>
  </div>

  <% end %>

  <br>
</div>

<br>
<br>




<div class="accordionDiv">
  <div class="accordion" id="accordionExample" style="width: 90vw;">
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
          Reported Balances History
        </button>
      </h2>
        <div id="collapseOne" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
          <div class="accordion-body">
            <% if @reported_balances.any? %>
              <div class="table-responsive resptbl-class">
                <table id="ftztable" class="table table-striped table-sm table-hover display responsive no-wrap">
                  <thead>
                    <tr>
                      <th>Tank</th>
                      <th>Item Number</th>
                      <th>Balance Date</th>
                      <th>Balance Quantity</th>
                      <th>UOM</th>
                      <th>Calculated Date</th>
                      <th style="min-width:100px; max-width:100px;">Recalculate</th>
                      <th style="min-width:50; max-width:50;">Delete</th>
                    </tr>
                  </thead>
                  <tbody id="myTable">
                    <% @reported_balances.each do |f| %>
                      <tr>
                        <td><%= f.warehouse %></td>
                        <td><%= f.itemnumber %></td>
                        <td><%= f.balancedate&.strftime('%Y-%m-%d %H:%M:%S') %></td>
                        <td><%= f.balancequantity %></td>
                        <td><%= f.uom %></td>
                        <td><%= f.calculateddate&.in_time_zone("EST")&.strftime('%Y-%m-%d %H:%M:%S') %></td>
                        <td style="min-width:100px; max-width:100px; ">
                          <%= link_to "Calculate Balance", recalculate_balance_path(f.balancedate.strftime('%Y-%m-%d %H:%M:%S')), class: "btn btn-light btn-sm btn-search"%>            
                        </td>
                        <td style="min-width:50; max-width:50;">
                          <%#= link_to "Delete", verify_delete_path(caller: "report_balances", warehouse: f.warehouse, itemnumber: f.itemnumber, uom: f.uom, balancequantity: f.balancequantity, balancedate: f.balancedate.strftime('%Y-%m-%d %H:%M:%S')), method: :get, remote: true, class: "btn btn-danger btn-sm" %>
                          <%= link_to '<i class="fas fa-trash-alt fa-md center" aria-hidden="true" style="float: none; color: #d50015; padding-left: 13px;"></i>'.html_safe, verify_delete_path(caller: "report_balances", warehouse: f.warehouse, itemnumber: f.itemnumber, uom: f.uom, balancequantity: f.balancequantity, balancedate: f.balancedate.strftime('%Y-%m-%d %H:%M:%S')), method: :get, remote: true, class: "icon-delete" %>
                          </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
              <div class="ftz_pagination">
                <%= will_paginate @reported_balances, :previous_label => 'prev', :next_label => 'next', param_name: 'reported_balances_page' %>
              </div>
            <% else %>
              <span style="font-style:italic;">No recorded balances yet</span>
              <br>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
<br>
<br>

<script>
  $(document).ready(function() {
   
    var errors_array = []

    var balance_date = $("#balancedate").val()
    var itemnumber = $("#itemnumber").val()
    var quantity = $("#balancequantity").val()
    
    if (balance_date === null || balance_date === undefined || balance_date === '') {
      errors_array.push('balancedate')
    }

    if (quantity === null || quantity === undefined || quantity === '') {
      errors_array.push('quantity');
    }

    if (itemnumber == 'Select a Product') {
      errors_array.push('itemnumber')
    }

    if (errors_array.length > 0) {
      $("input[type='submit']").prop("disabled", true);
    }

    checkError(errors_array)



    $("#balancedate").on("change click keyup", function() {
      $('.element').hide();
      if (this.value !== null && this.value !== undefined && this.value !== '') {
        $("#select-balancedate-error").hide().removeClass("text-danger criteria-display-smplbw");
        errors_array = errors_array.filter(item => item !== 'balancedate');
        if (errors_array.length <= 0) {
          initiateValidate()
        }
        //checkError(errors_array)
      } else {
        if (errors_array.includes('balancedate')) {
          checkError(errors_array)
        } else {
          errors_array.push('balancedate')
          checkError(errors_array)
        }
      }
    })

    $("#balancequantity").on("click keyup", function() {
      $('.element').hide();
      if (this.value !== null && this.value !== undefined && this.value !== '') {
        $("#select-balancequantity-error").hide().removeClass("text-danger criteria-display-smplbw");
        errors_array = errors_array.filter(item => item !== 'quantity');
        if (errors_array.length <= 0) {
          initiateValidate()
        }
        //checkError(errors_array)
      } else {
        errors_array.push('quantity')
        checkError(errors_array)
      }
    })

    // Add a change event listener to the tank dropdown
    $("#itemnumber").on("change", function() {
      $('.element').hide();
      if (this.value !== 'Select a Product') {
        $("#select-itemnumber-error").hide().removeClass("text-danger criteria-display-smplbw");
        errors_array = errors_array.filter(item => item !== 'itemnumber');
        if (errors_array.length <= 0) {
          initiateValidate()
        }
      } else {
        errors_array.push('itemnumber')
        checkError(errors_array)
      }

      var selectedProduct = $(this).val(); // Get the selected product

      // Use a flag to track if a match has been found
      var matchFound = false;

      // Initialize the UOM variable
      var uom = "";

      // Loop through your @part_numbers data to find the matching UOM
      <% @part_numbers.each do |part| %>
        if ("<%= part.partnumber %>" === selectedProduct) {
          matchFound = true;
          uom = "<%= part.uom %>";
        }
      <% end %>

      // Check if a match was found and set the value
      if (matchFound) {
        $("#uom-text-field-balances").val(uom);
      } else {
        // Handle the case when no match is found
        $("#uom-text-field-balances").val("");
      }
    });



    function checkError(errors_array) {
      if (errors_array.length <= 0) {
        $("input[type='submit']").prop("disabled", false);
        $("#select-balancedate-error").hide()
        $("#select-balancequantity-error").hide();
        $("#select-itemnumber-error").hide();
        $('.warehousebalancesuniqueidentifier').removeClass('progress-border-bad').addClass('progress-border-good');

      } else {
        $('.warehousebalancesuniqueidentifier').removeClass('progress-border-good').addClass('progress-border-bad');
        $("input[type='submit']").prop("disabled", true);
        for (error of errors_array) {

          switch (error) {
            case "itemnumber":
              $("#select-itemnumber-error").show().addClass("text-danger criteria-display-smplbw");
              break;
            case "balancedate":
              $("#select-balancedate-error").show().addClass("text-danger criteria-display-smplbw");
              break;
            case "quantity":
              $("#select-balancequantity-error").show().addClass("text-danger criteria-display-smplbw");
              break;
          }
        }
      }
    }

    function initiateValidate() {
      $("input[type='submit']").prop("disabled", false);
      $('.warehousebalancesuniqueidentifier').removeClass('progress-border-bad').addClass('progress-border-good');
    }

  
    var recalculated_with_btn = $("#recalculated_with_btn").val()
    //console.log(recalculated_with_btn)
    if (recalculated_with_btn == 'SHOWDISCREPMESSAGE') {
      
      $.ajax({
        url: '/discrepancy_modal',
        success: function(response) {

        },
        error: function(error) {
          //console.log('Error retrieving record: ' + error[1]);
        }
      });
    }
  });
</script>
