<turbo-frame id="edit_user_access">
<style>
.position {
  float: left;
}
</style>

<div class="modal fade" id="edituseraccess" tabindex="-1" role="dialog" aria-labelledby="conbalModalLabel" aria-hidden="true" data-backdrop="static">
  <div class="modal-dialog" role="document">
    <div class="modal-content" style="background-color: #fff;">
      <div class="modal-header editmdhd alert alert-primary" style="padding-bottom: 15px;">
        <h1 class="modal-title justify-content-center" style="font-size: 25px; align-items: center !important; text-align:center !important; text-shadow: none;" id="">Edit User Roles</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button><br>
      </div>
      <div class="modal-body">
      

      <div class="justify-content-center" style="text-align: center; padding-top: 20px;">

        <%= form_for to_the_controller_path, data: { turbo: false } do |f| %>
          <%= f.hidden_field :email, value: @email %>
          <div class="row justify-content-center" style="text-align: center;">
            <div class="col-6 justify-content-center" style="text-align: center;">  
              <%= f.label :warehouse, "Warehouse Access", class: "required position" %>
              <%= select_tag :warehouse, options_for_select(['Select warehouse...'] + @warehouses.collect {|p| [p.warehouse]}),{ autofocus: true, class: " form-control mb-3", id: "warehouse_select_dropdown", required: true}%>
            </div>
            <div class="col-6 justify-content-center" style="text-align: center;">  
              
              <div class="roles-multiple-fields">
                <%= render 'add_nested_fields_for_roles', current_index: 0, usersetup: @usersetup %>
              </div>
              <br>
            </div>

          </div>

          <div class="row justify-content-center" style="text-align: center; padding-bottom: 20px;">
            
            <div class="col-6 justify-content-center" style="float:right; text-align: center;">
              <%= f.submit "Submit", class: 'btn btn-sm btn-search', style: 'width: 75%;'%>     
            </div>  
          </div>
        <% end %>

            <div class="table-responsive resptbl-class" style="border-top: 1.5px solid #000000; padding-top: 20px;">
              <% if @pendingWarehouse.any? %>
                <p style="font-style: italic;">Warehouse with default value of 0000 will be automatically replaced</p>
              <% end %>
              <table id="ftztable" class="table table-striped table-sm table-hover display responsive no-wrap">
                <thead class="thead-dark">
                  <thead>
                    <tr>
                      <th>Delete</th>
                      <th>Company</th>
                      <th>Username</th>
                      <th>Email</th>
                      <th>Warehouse</th>
                      <th>
                    </tr>
                  </thead>
                  <tbody id="myTable" style="text-align:center;">
                    <% @show_firmsaccess_for_user.each do |f| %>
                      <tr>
                        <td class="pad-tr"><%= link_to '<i class="fa fa-times fa-sm center" aria-hidden="true" style = "padding-top: 15px;"></i>'.html_safe, verify_delete_path(caller: "delete_roles", firmsEmail: f.email, warehouse: f.warehouse), remote: true, class: "icon-edit", 'data-bs-dismiss': 'modal' %></td>
                        
                        <% if User.where(email: f.email).pluck(:company).first.present? %>
                          <td class="pad-tr"><%= User.where(email: f.email).pluck(:company).first %></td>
                        <% else %>
                          <td class="pad-tr" style="font-weight: bold;">Pending</td>
                        <% end %>

                        <% if User.where(email: f.email).pluck(:username).first.present? %>
                          <td class="pad-tr"><%= User.where(email: f.email).pluck(:username).first %></td>
                        <% else %>
                          <td class="pad-tr" style="font-weight: bold;">Pending</td>
                        <% end %>
                        
                        <td class="pad-tr"><%= f.email %></td>
                        <td class="pad-tr"><%= f.warehouse %></td>
                      </tr>

                        <tr>
                          <td class="justify-content-center pad-tr" colspan="5" style="text-align:center;">
                            <% warehousesetup_list = UserWarehouseRole.where(warehouse: f.warehouse).where(user_email: f.email).order(warehouse: :asc) %>
                            <% warehousesetup_list.each_with_index do |warehouseaccess, index| %>
                              <%= warehouseaccess.role %>
                              <%= ',' unless index == warehousesetup_list.size - 1 %>
                            <% end %>
                          </td>
                        </tr>

                    <% end %>
                  </tbody>
                </thead>
              </table>
            </div>

</div>
      </div>

        <div class="modal-footer editmdft">

        <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>

      </div>

    </div>
  </div>
 </div>


 
 <script>
  document.addEventListener("turbo:frame-load", function() {
    var currentIndex = 0; // Initialize the index

    // Event handler for the Add Additional roles for User button
    $('.modal-body').on('click', '.add-nested-fields-for-roles', function() {
      var rolesFields = $('.roles-multiple-fields').first().clone();

      rolesFields.find('input').val('');

      // Increment the index for the cloned fields
      currentIndex++;

      // Update the name attribute in the cloned fields
      rolesFields.find('[id*="roles"]').attr('id', 'usersetup[multiform][' + currentIndex + '][roles]');
      rolesFields.find('[name*="roles"]').attr('name', 'usersetup[multiform][' + currentIndex + '][roles]');

      // Append the cloned fields to the container
      $('.roles-multiple-fields').last().after(rolesFields);
    });

    // Example: Event handler for the form submission
  //  $('.modal-body form').on('submit', function() {
      // Your logic for when the form is submitted
  //  });
  });

  document.addEventListener("turbo:frame-load", function(event) {
    console.log("Frame loaded: " + event.target.id);
    if (event.target.id === "edit_user_access") {
      var modalElement = document.getElementById("edituseraccess");
      if (modalElement) {
        var modal = new bootstrap.Modal(modalElement);
        modal.show();
      }
    }
  });
</script>
</turbo-frame>
